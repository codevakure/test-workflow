name: Branch and PR Title Check

on:
  pull_request:
    types: [opened, edited, synchronize]

permissions:
  pull-requests: write
  contents: read
  issues: write
  statuses: write

jobs:
  check-branch-and-pr-title:
    runs-on: ubuntu-latest

    steps:
      - name: Check out the repository
        uses: actions/checkout@v3

      - name: Create status file
        run: |
          echo "BRANCH_VALID=false" > status.txt
          echo "PR_TITLE_VALID=false" >> status.txt
          echo "BRANCH_ERROR=''" >> status.txt
          echo "PR_TITLE_ERROR=''" >> status.txt

      - name: Validate branch name
        id: validate-branch
        run: |
          EXCEPTION_BRANCHES=("develop" "test" "main" "test/" "develop/" "release/")
          BRANCH_NAME="${{ github.event.pull_request.head.ref }}"
          VALID_PREFIXES=("feature" "sprint" "us" "hotfix" "bug")
          BRANCH_NAME_LOWER=$(echo "$BRANCH_NAME" | tr '[:upper:]' '[:lower:]')
          PREFIX_MATCHES=false
          
          for EXCEPTION in "${EXCEPTION_BRANCHES[@]}"; do
            if [[ "$BRANCH_NAME" == "$EXCEPTION"* ]]; then
              echo "BRANCH_VALID=true" > status.txt
              echo "BRANCH_ERROR=''" >> status.txt
              echo "Branch name '$BRANCH_NAME' is an exception and is valid."
              exit 0
            fi
          done
          
          for PREFIX in "${VALID_PREFIXES[@]}"; do
            PREFIX_LOWER=$(echo "$PREFIX" | tr '[:upper:]' '[:lower:]')
            if [[ "$BRANCH_NAME_LOWER" =~ ^"$PREFIX_LOWER"-ab#[0-9]+-[a-z0-9][a-z0-9-]*$ ]]; then
              PREFIX_MATCHES=true
              break
            fi
          done
          
          if [ "$PREFIX_MATCHES" = true ]; then
            echo "BRANCH_VALID=true" > status.txt
            echo "BRANCH_ERROR=''" >> status.txt
            echo "Branch name '$BRANCH_NAME' is valid."
          else
            ERROR_MSG="Branch name '$BRANCH_NAME' does not follow the required format. Must start with one of: ${VALID_PREFIXES[*]} (case insensitive), include AB# followed by numbers, and have a descriptive name. Example: feature-AB#123456-add-payment-integration"
            echo "BRANCH_VALID=false" > status.txt
            echo "BRANCH_ERROR=$ERROR_MSG" >> status.txt
            echo "::error::Invalid branch name. Check PR comments for details."
          fi

      - name: Validate PR title
        id: validate-pr-title
        run: |
          EXCEPTION_PREFIXES=("develop" "test" "main" "test/" "develop/" "release/")
          PR_TITLE="${{ github.event.pull_request.title }}"
          VALID_PREFIXES=("feature" "sprint" "us" "hotfix" "bug")
          PR_TITLE_LOWER=$(echo "$PR_TITLE" | tr '[:upper:]' '[:lower:]')
          PREFIX_MATCHES=false
          
          for EXCEPTION in "${EXCEPTION_PREFIXES[@]}"; do
            if [[ "$PR_TITLE" == "$EXCEPTION"* ]]; then
              echo "PR_TITLE_VALID=true" >> status.txt
              echo "PR_TITLE_ERROR=''" >> status.txt
              echo "PR title '$PR_TITLE' is an exception and is valid."
              exit 0
            fi
          done
          
          for PREFIX in "${VALID_PREFIXES[@]}"; do
            PREFIX_LOWER=$(echo "$PREFIX" | tr '[:upper:]' '[:lower:]')
            if [[ "$PR_TITLE_LOWER" =~ ^"$PREFIX_LOWER"-ab#[0-9]+-[a-z0-9][a-z0-9-]*$ ]]; then
              PREFIX_MATCHES=true
              break
            fi
          done
          
          if [ "$PREFIX_MATCHES" = true ]; then
            echo "PR_TITLE_VALID=true" >> status.txt
            echo "PR_TITLE_ERROR=''" >> status.txt
            echo "PR title '$PR_TITLE' is valid."
          else
            ERROR_MSG="PR title '$PR_TITLE' does not follow the required format. Must start with one of: ${VALID_PREFIXES[*]} (case insensitive), include AB# followed by numbers, and have a descriptive name. Example: feature-AB#123456-add-payment-integration"
            echo "PR_TITLE_VALID=false" >> status.txt
            echo "PR_TITLE_ERROR=$ERROR_MSG" >> status.txt
            echo "::error::Invalid PR title. Check PR comments for details."
          fi

      - name: Post comment if validation failed
        if: always()
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          source status.txt
          if [ "$BRANCH_VALID" = "false" ] || [ "$PR_TITLE_VALID" = "false" ]; then
            COMMENT=""
            COMMENT+="## ‚ùå Validation Failed\n\n"
            
            if [ "$BRANCH_VALID" = "false" ]; then
              COMMENT+="### Branch Name Error\n"
              COMMENT+="$BRANCH_ERROR\n\n"
              COMMENT+="Valid examples:\n"
              COMMENT+="- feature-AB#123456-add-payment-integration\n"
              COMMENT+="- us-AB#78901-update-user-profile\n"
              COMMENT+="- hotfix-AB#23456-fix-login-issue\n\n"
            fi
            
            if [ "$PR_TITLE_VALID" = "false" ]; then
              COMMENT+="### PR Title Error\n"
              COMMENT+="$PR_TITLE_ERROR\n\n"
              COMMENT+="Valid examples:\n"
              COMMENT+="- feature-AB#123456-add-payment-integration\n"
              COMMENT+="- us-AB#78901-update-user-profile\n"
              COMMENT+="- hotfix-AB#23456-fix-login-issue\n"
            fi
            
            echo -e "$COMMENT" | gh pr comment ${{ github.event.pull_request.number }} --body-file -
          fi

      - name: Block PR if validation failed
        if: always()
        run: |
          source status.txt
          if [ "$BRANCH_VALID" != "true" ] || [ "$PR_TITLE_VALID" != "true" ]; then
            echo "::error::Validation failed. Please fix the branch name and/or PR title according to the guidelines in the PR comments."
            exit 1
          fi