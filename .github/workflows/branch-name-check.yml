name: Branch and PR Title Check

on:
  pull_request:
    types: [opened, edited, synchronize]

# Add permissions for the GitHub token
permissions:
  pull-requests: write
  contents: read
  issues: write

jobs:
  check-branch-and-pr-title:
    runs-on: ubuntu-latest

    steps:
      - name: Check out the repository
        uses: actions/checkout@v3

      - name: Validate branch name
        id: validate-branch
        shell: bash
        run: |
          EXCEPTION_BRANCHES=("develop" "test" "main" "test/" "develop/" "release/")
          BRANCH_NAME="${{ github.event.pull_request.head.ref }}"
          VALID_PREFIXES=("feature" "sprint" "us" "hotfix" "bug")
          
          # Make branch name lowercase for comparison
          BRANCH_NAME_LOWER=$(echo "$BRANCH_NAME" | tr '[:upper:]' '[:lower:]')
          
          # Convert prefixes to lowercase for comparison
          VALID_PREFIXES_LOWER=()
          for prefix in "${VALID_PREFIXES[@]}"; do
            VALID_PREFIXES_LOWER+=("$(echo "$prefix" | tr '[:upper:]' '[:lower:]')")
          done
          
          # Create regex pattern with lowercase prefixes
          PREFIX_PATTERN=$(IFS=\|; echo "${VALID_PREFIXES_LOWER[*]}")
          VALID_FORMAT="^($PREFIX_PATTERN)-ab#[0-9]+-[a-z0-9][a-z0-9-]*$"

          BRANCH_VALID=false

          # Check for exception branches first
          for EXCEPTION in "${EXCEPTION_BRANCHES[@]}"; do
            if [[ "$BRANCH_NAME" == "$EXCEPTION"* ]]; then
              echo "branch_valid=true" >> $GITHUB_OUTPUT
              echo "Branch name '$BRANCH_NAME' is an exception and is valid."
              exit 0
            fi
          done

          # Validate branch name
          if [[ "$BRANCH_NAME_LOWER" =~ $VALID_FORMAT ]]; then
            echo "branch_valid=true" >> $GITHUB_OUTPUT
            echo "Branch name '$BRANCH_NAME' is valid."
          else
            echo "branch_valid=false" >> $GITHUB_OUTPUT
            ERROR_MESSAGE="Branch name '$BRANCH_NAME' does not follow the required format:
            - Must start with one of: ${VALID_PREFIXES[*]} (case insensitive)
            - Must include AB# followed by numbers
            - Must have a descriptive name after the ticket number
            Example: feature-AB#123456-add-payment-integration"
            echo "::error::$ERROR_MESSAGE"
          fi

      - name: Validate PR title
        id: validate-pr-title
        shell: bash
        run: |
          EXCEPTION_PREFIXES=("develop" "test" "main" "test/" "develop/" "release/")
          PR_TITLE="${{ github.event.pull_request.title }}"
          VALID_PREFIXES=("feature" "sprint" "us" "hotfix" "bug")
          
          # Make PR title lowercase for comparison
          PR_TITLE_LOWER=$(echo "$PR_TITLE" | tr '[:upper:]' '[:lower:]')
          
          # Convert prefixes to lowercase for comparison
          VALID_PREFIXES_LOWER=()
          for prefix in "${VALID_PREFIXES[@]}"; do
            VALID_PREFIXES_LOWER+=("$(echo "$prefix" | tr '[:upper:]' '[:lower:]')")
          done
          
          # Create regex pattern with lowercase prefixes
          PREFIX_PATTERN=$(IFS=\|; echo "${VALID_PREFIXES_LOWER[*]}")
          VALID_FORMAT="^($PREFIX_PATTERN)-ab#[0-9]+-[a-z0-9][a-z0-9-]*$"

          PR_TITLE_VALID=false

          # Check for exception prefixes first
          for EXCEPTION in "${EXCEPTION_PREFIXES[@]}"; do
            if [[ "$PR_TITLE" == "$EXCEPTION"* ]]; then
              echo "pr_title_valid=true" >> $GITHUB_OUTPUT
              echo "PR title '$PR_TITLE' is an exception and is valid."
              exit 0
            fi
          done

          # Validate PR title
          if [[ "$PR_TITLE_LOWER" =~ $VALID_FORMAT ]]; then
            echo "pr_title_valid=true" >> $GITHUB_OUTPUT
            echo "PR title '$PR_TITLE' is valid."
          else
            echo "pr_title_valid=false" >> $GITHUB_OUTPUT
            ERROR_MESSAGE="PR title '$PR_TITLE' does not follow the required format:
            - Must start with one of: ${VALID_PREFIXES[*]} (case insensitive)
            - Must include AB# followed by numbers
            - Must have a descriptive name after the ticket number
            Example: feature-AB#123456-add-payment-integration"
            echo "::error::$ERROR_MESSAGE"
          fi

      - name: Comment PR
        if: always()
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          BRANCH_VALID=$(cat $GITHUB_OUTPUT | grep "^branch_valid=" | cut -d= -f2)
          PR_TITLE_VALID=$(cat $GITHUB_OUTPUT | grep "^pr_title_valid=" | cut -d= -f2)
          
          COMMENT="## Branch and PR Title Validation Results\n\n"
          
          # Add branch validation results
          COMMENT+="### Branch Name Check\n"
          if [ "$BRANCH_VALID" = "true" ]; then
            COMMENT+="✅ Branch name is valid\n\n"
          else
            COMMENT+="❌ Branch name is invalid\n\n"
          fi
          
          # Add PR title validation results
          COMMENT+="### PR Title Check\n"
          if [ "$PR_TITLE_VALID" = "true" ]; then
            COMMENT+="✅ PR title is valid\n\n"
          else
            COMMENT+="❌ PR title is invalid\n\n"
          fi
          
          # Post comment using gh cli
          echo -e "$COMMENT" | gh pr comment ${{ github.event.pull_request.number }} --body-file -

      - name: Final validation
        if: always()
        shell: bash
        run: |
          BRANCH_VALID=$(cat $GITHUB_OUTPUT | grep "^branch_valid=" | cut -d= -f2)
          PR_TITLE_VALID=$(cat $GITHUB_OUTPUT | grep "^pr_title_valid=" | cut -d= -f2)

          if [ "$BRANCH_VALID" != "true" ] || [ "$PR_TITLE_VALID" != "true" ]; then
            exit 1
          fi