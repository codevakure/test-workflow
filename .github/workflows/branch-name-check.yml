name: Branch and PR Title Check

on:
    pull_request:
        types: [opened, edited]

permissions:
    pull-requests: write
    contents: read
    issues: write
    statuses: write

jobs:
    check-branch-and-pr-title:
        runs-on: ubuntu-latest
        env:
            BRANCH_VALID: "false"
            PR_TITLE_VALID: "false"

        steps:
            - name: Check out the repository
              uses: actions/checkout@v3

            - name: Validate branch name
              id: validate-branch
              run: |
                  EXCEPTION_BRANCHES=("develop" "test" "main" "test/" "develop/" "release/")
                  BRANCH_NAME="${{ github.event.pull_request.head.ref }}"
                  VALID_PREFIXES=("feature" "sprint" "us" "hotfix" "bug")
                  BRANCH_NAME_LOWER=$(echo "$BRANCH_NAME" | tr '[:upper:]' '[:lower:]')
                  PREFIX_MATCHES=false
                  
                  for EXCEPTION in "${EXCEPTION_BRANCHES[@]}"; do
                      if [[ "$BRANCH_NAME" == "$EXCEPTION"* ]]; then
                          echo "BRANCH_VALID=true" >> $GITHUB_ENV
                          echo "Branch name '$BRANCH_NAME' is an exception and is valid."
                          exit 0
                      fi
                  done
                  
                  for PREFIX in "${VALID_PREFIXES[@]}"; do
                      PREFIX_LOWER=$(echo "$PREFIX" | tr '[:upper:]' '[:lower:]')
                      if [[ "$BRANCH_NAME_LOWER" =~ ^"$PREFIX_LOWER"-ab#[0-9]+-[a-z0-9][a-z0-9-]*$ ]]; then
                          PREFIX_MATCHES=true
                          break
                      fi
                  done
                  
                  if [ "$PREFIX_MATCHES" = true ]; then
                      echo "BRANCH_VALID=true" >> $GITHUB_ENV
                      echo "Branch name '$BRANCH_NAME' is valid."
                  else
                      echo "BRANCH_VALID=false" >> $GITHUB_ENV
                      echo "::error::Invalid branch name. Check PR comments for details."
                  fi

            - name: Validate PR title
              id: validate-pr-title
              run: |
                  EXCEPTION_PREFIXES=("develop" "test" "main" "test/" "develop/" "release/")
                  PR_TITLE="${{ github.event.pull_request.title }}"
                  VALID_PREFIXES=("feature" "sprint" "us" "hotfix" "bug")
                  PR_TITLE_LOWER=$(echo "$PR_TITLE" | tr '[:upper:]' '[:lower:]')
                  PREFIX_MATCHES=false
                  
                  for EXCEPTION in "${EXCEPTION_PREFIXES[@]}"; do
                      if [[ "$PR_TITLE" == "$EXCEPTION"* ]]; then
                          echo "PR_TITLE_VALID=true" >> $GITHUB_ENV
                          echo "PR title '$PR_TITLE' is an exception and is valid."
                          exit 0
                      fi
                  done
                  
                  # Split PR title for initial prefix check
                  FIRST_PART=$(echo "$PR_TITLE_LOWER" | cut -d ' ' -f1)
                  REMAINDER=$(echo "$PR_TITLE_LOWER" | cut -d ' ' -f2-)
                  
                  # Check if first part matches prefix (either directly or with hyphen)
                  for PREFIX in "${VALID_PREFIXES[@]}"; do
                      PREFIX_LOWER=$(echo "$PREFIX" | tr '[:upper:]' '[:lower:]')
                      
                      # Check three formats:
                      # 1. <type> AB#<number> <description>
                      # 2. <type>-AB#<number>-<description>
                      # 3. <type>-AB#<number> <description>
                      
                      if [[ "$FIRST_PART" == "$PREFIX_LOWER" || "$FIRST_PART" == "$PREFIX_LOWER-"* ]]; then
                          # For space-separated format
                          if [[ "$FIRST_PART" == "$PREFIX_LOWER" && "$REMAINDER" =~ ^ab#[0-9]+[[:space:]].+$ ]]; then
                              PREFIX_MATCHES=true
                              break
                          fi
                          
                          # For hyphenated format
                          if [[ "$FIRST_PART" == "$PREFIX_LOWER-ab#"* && "$FIRST_PART" =~ ^.*-ab#[0-9]+$ && -n "$REMAINDER" ]]; then
                              PREFIX_MATCHES=true
                              break
                          fi
                          
                          # For mixed format (<type>-AB#<number> <description>)
                          if [[ "$FIRST_PART" == "$PREFIX_LOWER-ab#"* && "$FIRST_PART" =~ ^.*-ab#[0-9]+$ && -n "$REMAINDER" ]]; then
                              PREFIX_MATCHES=true
                              break
                          fi
                      fi
                  done
                  
                  if [ "$PREFIX_MATCHES" = true ]; then
                      echo "PR_TITLE_VALID=true" >> $GITHUB_ENV
                      echo "PR title '$PR_TITLE' is valid."
                  else
                      echo "PR_TITLE_VALID=false" >> $GITHUB_ENV
                      echo "::error::Invalid PR title. Check PR comments for details."
                  fi
                  
            - name: Manage PR Comments
              if: env.BRANCH_VALID == 'false' || env.PR_TITLE_VALID == 'false'
              uses: actions/github-script@v6
              env:
                  BRANCH_NAME: ${{ github.event.pull_request.head.ref }}
                  PR_TITLE: ${{ github.event.pull_request.title }}
              with:
                  github-token: ${{ github.token }}
                  script: |
                    // First, get all existing comments
                    const { data: comments } = await github.rest.issues.listComments({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      issue_number: context.issue.number
                    });
                    
                    // Delete existing validation comments
                    for (const comment of comments) {
                      if (comment.body.includes('Validation Failed') &&
                          comment.user.login === 'github-actions[bot]') {
                        try {
                          await github.rest.issues.deleteComment({
                            owner: context.repo.owner,
                            repo: context.repo.repo,
                            comment_id: comment.id
                          });
                        } catch (error) {
                          console.error(`Error deleting comment ${comment.id}:`, error);
                        }
                      }
                    }
                    
                    // Prepare new comment
                    let message = "**❌ Validation Failed**\n\n";
                    message += "**Review PR Guidelines**\n\n";
                    
                    if (process.env.BRANCH_VALID === 'false') {
                      message += `❗ Branch Name Error: \`\u001b[31m${process.env.BRANCH_NAME}\u001b[0m\`\n`
                    }
                    
                    if (process.env.PR_TITLE_VALID === 'false') {
                      message += `❗ PR Title Error: \`\u001b[31m${process.env.PR_TITLE}\u001b[0m\`\n`
                    }
                    
                    message += "Please follow our PR creation guidelines:\n" +
                              "www.example.com";
                    
                    // Post new comment
                    await github.rest.issues.createComment({
                      issue_number: context.issue.number,
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      body: message
                    });

            - name: Block PR if validation failed
              if: env.BRANCH_VALID == 'false' || env.PR_TITLE_VALID == 'false'
              run: |
                  echo "::error::Validation failed. Please fix the branch name and/or PR title according to the guidelines in the PR comments."
                  exit 1