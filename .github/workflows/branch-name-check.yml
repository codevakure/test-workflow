name: Branch and PR Title Check

on:
  pull_request:
    types: [opened, edited, synchronize]

permissions:
  pull-requests: write
  contents: read
  issues: write
  statuses: write

jobs:
  check-branch-and-pr-title:
    runs-on: ubuntu-latest
    env:
      BRANCH_VALID: "false"
      PR_TITLE_VALID: "false"

    steps:
      - name: Check out the repository
        uses: actions/checkout@v3

      - name: Validate branch name
        id: validate-branch
        run: |
          EXCEPTION_BRANCHES=("develop" "test" "main" "test/" "develop/" "release/")
          BRANCH_NAME="${{ github.event.pull_request.head.ref }}"
          VALID_PREFIXES=("feature" "sprint" "us" "hotfix" "bug")
          BRANCH_NAME_LOWER=$(echo "$BRANCH_NAME" | tr '[:upper:]' '[:lower:]')
          PREFIX_MATCHES=false
          
          for EXCEPTION in "${EXCEPTION_BRANCHES[@]}"; do
            if [[ "$BRANCH_NAME" == "$EXCEPTION"* ]]; then
              echo "BRANCH_VALID=true" >> $GITHUB_ENV
              echo "Branch name '$BRANCH_NAME' is an exception and is valid."
              exit 0
            fi
          done
          
          for PREFIX in "${VALID_PREFIXES[@]}"; do
            PREFIX_LOWER=$(echo "$PREFIX" | tr '[:upper:]' '[:lower:]')
            if [[ "$BRANCH_NAME_LOWER" =~ ^"$PREFIX_LOWER"-ab#[0-9]+-[a-z0-9][a-z0-9-]*$ ]]; then
              PREFIX_MATCHES=true
              break
            fi
          done
          
          if [ "$PREFIX_MATCHES" = true ]; then
            echo "BRANCH_VALID=true" >> $GITHUB_ENV
            echo "Branch name '$BRANCH_NAME' is valid."
          else
            echo "BRANCH_VALID=false" >> $GITHUB_ENV
            echo "::error::Invalid branch name. Check PR comments for details."
          fi

      - name: Validate PR title
        id: validate-pr-title
        run: |
          EXCEPTION_PREFIXES=("develop" "test" "main" "test/" "develop/" "release/")
          PR_TITLE="${{ github.event.pull_request.title }}"
          VALID_PREFIXES=("feature" "sprint" "us" "hotfix" "bug")
          PR_TITLE_LOWER=$(echo "$PR_TITLE" | tr '[:upper:]' '[:lower:]')
          PREFIX_MATCHES=false
          
          for EXCEPTION in "${EXCEPTION_PREFIXES[@]}"; do
            if [[ "$PR_TITLE" == "$EXCEPTION"* ]]; then
              echo "PR_TITLE_VALID=true" >> $GITHUB_ENV
              echo "PR title '$PR_TITLE' is an exception and is valid."
              exit 0
            fi
          done
          
          for PREFIX in "${VALID_PREFIXES[@]}"; do
            PREFIX_LOWER=$(echo "$PREFIX" | tr '[:upper:]' '[:lower:]')
            if [[ "$PR_TITLE_LOWER" =~ ^"$PREFIX_LOWER"-ab#[0-9]+-[a-z0-9][a-z0-9-]*$ ]]; then
              PREFIX_MATCHES=true
              break
            fi
          done
          
          if [ "$PREFIX_MATCHES" = true ]; then
            echo "PR_TITLE_VALID=true" >> $GITHUB_ENV
            echo "PR title '$PR_TITLE' is valid."
          else
            echo "PR_TITLE_VALID=false" >> $GITHUB_ENV
            echo "::error::Invalid PR title. Check PR comments for details."
          fi

      - name: Post comment if validation failed
        if: env.BRANCH_VALID == 'false' || env.PR_TITLE_VALID == 'false'
        env:
          GH_TOKEN: ${{ github.token }}
          BRANCH_NAME: ${{ github.event.pull_request.head.ref }}
          PR_TITLE: ${{ github.event.pull_request.title }}
        run: |
          COMMENT="## ‚ùå Validation Failed\n\n"
          
          if [ "$BRANCH_VALID" = "false" ]; then
            COMMENT+="### Branch Name Error\n"
            COMMENT+="Branch name '${BRANCH_NAME}' does not follow the required format.\n\n"
            COMMENT+="Required format:\n"
            COMMENT+="- Must start with: feature, sprint, us, hotfix, or bug (case insensitive)\n"
            COMMENT+="- Must include AB# followed by numbers\n"
            COMMENT+="- Must have a descriptive name\n\n"
            COMMENT+="Valid examples:\n"
            COMMENT+="- feature-AB#123456-add-payment-integration\n"
            COMMENT+="- us-AB#78901-update-user-profile\n"
            COMMENT+="- hotfix-AB#23456-fix-login-issue\n\n"
          fi
          
          if [ "$PR_TITLE_VALID" = "false" ]; then
            COMMENT+="### PR Title Error\n"
            COMMENT+="PR title '${PR_TITLE}' does not follow the required format.\n\n"
            COMMENT+="Required format:\n"
            COMMENT+="- Must start with: feature, sprint, us, hotfix, or bug (case insensitive)\n"
            COMMENT+="- Must include AB# followed by numbers\n"
            COMMENT+="- Must have a descriptive name\n\n"
            COMMENT+="Valid examples:\n"
            COMMENT+="- feature-AB#123456-add-payment-integration\n"
            COMMENT+="- us-AB#78901-update-user-profile\n"
            COMMENT+="- hotfix-AB#23456-fix-login-issue\n"
          fi
          
          echo -e "$COMMENT" | gh pr comment ${{ github.event.pull_request.number }} --body-file -

      - name: Block PR if validation failed
        if: env.BRANCH_VALID == 'false' || env.PR_TITLE_VALID == 'false'
        run: |
          echo "::error::Validation failed. Please fix the branch name and/or PR title according to the guidelines in the PR comments."
          exit 1