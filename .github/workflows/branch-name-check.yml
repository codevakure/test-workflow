name: Branch and PR Title Check

on:
  pull_request:
    types: [opened, edited, synchronize]

jobs:
  check-branch-and-pr-title:
    runs-on: ubuntu-latest

    steps:
      - name: Check out the repository
        uses: actions/checkout@v3

      - name: Validate branch name
        id: validate-branch
        shell: bash
        run: |
          EXCEPTION_BRANCHES=("develop" "test" "main" "test/" "develop/" "release/")
          BRANCH_NAME="${{ github.event.pull_request.head.ref }}"
          BRANCH_NAME_LOWER=$(echo "$BRANCH_NAME" | tr '[:upper:]' '[:lower:]')
          VALID_PREFIXES=("feature" "sprint" "us" "hotfix" "bug")
          
          # Convert array to regex alternation
          PREFIX_PATTERN=$(IFS=\|; echo "${VALID_PREFIXES[*]}")
          VALID_FORMAT="^($PREFIX_PATTERN)-AB#[0-9]+-[a-zA-Z0-9][a-zA-Z0-9-]*$"

          BRANCH_VALID=false

          # Check for exception branches
          for EXCEPTION in "${EXCEPTION_BRANCHES[@]}"; do
            if [[ "$BRANCH_NAME" == "$EXCEPTION"* ]]; then
              echo "Branch name '$BRANCH_NAME' is an exception and does not need validation."
              BRANCH_VALID=true
              break
            fi
          done

          if [[ "$BRANCH_VALID" == false ]]; then
            if [[ ! "$BRANCH_NAME_LOWER" =~ $VALID_FORMAT ]]; then
              # Using GitHub Actions multiline output syntax
              echo "branch_valid=false" >> $GITHUB_OUTPUT
              {
                echo "branch_error<<EOF"
                echo "Branch name '$BRANCH_NAME' does not follow the required format:"
                echo "- Must start with one of: ${VALID_PREFIXES[*]} (case insensitive)"
                echo "- Must include AB# followed by numbers"
                echo "- Must have a descriptive name after the ticket number"
                echo "Example: feature-AB#123456-add-payment-integration"
                echo "EOF"
              } >> $GITHUB_OUTPUT
              echo "::error::Branch name validation failed. Check the PR comment for details."
            else
              echo "branch_valid=true" >> $GITHUB_OUTPUT
              echo "::notice::Branch name '$BRANCH_NAME' is valid."
            fi
          else
            echo "branch_valid=true" >> $GITHUB_OUTPUT
          fi

      - name: Validate PR title
        id: validate-pr-title
        shell: bash
        run: |
          EXCEPTION_PREFIXES=("develop" "test" "main" "test/" "develop/" "release/")
          PR_TITLE="${{ github.event.pull_request.title }}"
          PR_TITLE_LOWER=$(echo "$PR_TITLE" | tr '[:upper:]' '[:lower:]')
          VALID_PREFIXES=("feature" "sprint" "us" "hotfix" "bug")
          
          # Convert array to regex alternation
          PREFIX_PATTERN=$(IFS=\|; echo "${VALID_PREFIXES[*]}")
          VALID_FORMAT="^($PREFIX_PATTERN)-AB#[0-9]+-[a-zA-Z0-9][a-zA-Z0-9-]*$"

          PR_TITLE_VALID=false

          # Check for exception prefixes
          for EXCEPTION in "${EXCEPTION_PREFIXES[@]}"; do
            if [[ "$PR_TITLE" == "$EXCEPTION"* ]]; then
              echo "PR title '$PR_TITLE' is an exception and does not need validation."
              PR_TITLE_VALID=true
              break
            fi
          done

          if [[ "$PR_TITLE_VALID" == false ]]; then
            if [[ ! "$PR_TITLE_LOWER" =~ $VALID_FORMAT ]]; then
              # Using GitHub Actions multiline output syntax
              echo "pr_title_valid=false" >> $GITHUB_OUTPUT
              {
                echo "pr_title_error<<EOF"
                echo "PR title '$PR_TITLE' does not follow the required format:"
                echo "- Must start with one of: ${VALID_PREFIXES[*]} (case insensitive)"
                echo "- Must include AB# followed by numbers"
                echo "- Must have a descriptive name after the ticket number"
                echo "Example: feature-AB#123456-add-payment-integration"
                echo "EOF"
              } >> $GITHUB_OUTPUT
              echo "::error::PR title validation failed. Check the PR comment for details."
            else
              echo "pr_title_valid=true" >> $GITHUB_OUTPUT
              echo "::notice::PR title '$PR_TITLE' is valid."
            fi
          else
            echo "pr_title_valid=true" >> $GITHUB_OUTPUT
          fi

      - name: Create PR Comment
        if: always()
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const githubOutput = fs.readFileSync(process.env.GITHUB_OUTPUT, 'utf8');
            
            let comment = '## Branch and PR Title Validation Results\n\n';
            
            // Extract validation results
            const branchValid = githubOutput.includes('branch_valid=true');
            const prTitleValid = githubOutput.includes('pr_title_valid=true');
            
            // Function to extract error message between EOF delimiters
            const getError = (content, prefix) => {
              const regex = new RegExp(`${prefix}_error<<EOF\\n([\\s\\S]*?)\\nEOF`);
              const match = content.match(regex);
              return match ? match[1] : '';
            };
            
            // Branch validation results
            comment += '### Branch Name Check\n';
            if (branchValid) {
              comment += '✅ Branch name is valid\n\n';
            } else {
              const branchError = getError(githubOutput, 'branch');
              comment += `❌ Branch name is invalid\n\`\`\`\n${branchError}\n\`\`\`\n\n`;
            }
            
            // PR title validation results
            comment += '### PR Title Check\n';
            if (prTitleValid) {
              comment += '✅ PR title is valid\n\n';
            } else {
              const prTitleError = getError(githubOutput, 'pr_title');
              comment += `❌ PR title is invalid\n\`\`\`\n${prTitleError}\n\`\`\`\n\n`;
            }
            
            // Add the comment to the PR
            const prNumber = context.payload.pull_request.number;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: comment
            });

      - name: Final validation
        if: always()
        shell: bash
        run: |
          BRANCH_VALID=$(grep "branch_valid" $GITHUB_OUTPUT | cut -d '=' -f 2)
          PR_TITLE_VALID=$(grep "pr_title_valid" $GITHUB_OUTPUT | cut -d '=' -f 2)

          if [[ "$BRANCH_VALID" != "true" || "$PR_TITLE_VALID" != "true" ]]; then
            exit 1
          fi