name: Lint Check

on:
  pull_request:
    types: [opened, edited, synchronize]

permissions:
  pull-requests: write
  contents: read
  issues: write

jobs:
  run-lint:
    runs-on: ubuntu-latest

    steps:
      - name: Check out the repository
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "22.13.1"

      - name: Install dependencies
        run: npm install

      - name: Run lint and capture output
        id: lint
        run: |
          # Run lint and capture all output
          npm run lint > lint-output.txt 2>&1 || true
          
          # Initialize counters
          ERRORS=0
          WARNINGS=0
          
          # Check if there are any lint problems
          if [ -s lint-output.txt ]; then
            # Check for Angular CLI lint output format
            if grep -q "All files pass linting" lint-output.txt; then
              echo "status=success" >> $GITHUB_OUTPUT
              echo "message=All files pass linting" >> $GITHUB_OUTPUT
              echo "errors=0" >> $GITHUB_OUTPUT
              echo "warnings=0" >> $GITHUB_OUTPUT
            else
              # Count errors and warnings
              ERRORS=$(grep -c "error" lint-output.txt || echo "0")
              WARNINGS=$(grep -c "warning" lint-output.txt || echo "0")
              TOTAL=$((ERRORS + WARNINGS))
              
              if [ $TOTAL -gt 200 ]; then
                echo "status=failure" >> $GITHUB_OUTPUT
              else
                echo "status=warning" >> $GITHUB_OUTPUT
              fi
              
              echo "errors=$ERRORS" >> $GITHUB_OUTPUT
              echo "warnings=$WARNINGS" >> $GITHUB_OUTPUT
              echo "message=Found $ERRORS errors and $WARNINGS warnings" >> $GITHUB_OUTPUT
            fi
          else
            echo "status=success" >> $GITHUB_OUTPUT
            echo "message=No lint issues found" >> $GITHUB_OUTPUT
            echo "errors=0" >> $GITHUB_OUTPUT
            echo "warnings=0" >> $GITHUB_OUTPUT
          fi

      - name: Post lint results comment
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Read the lint results
          STATUS="${{ steps.lint.outputs.status }}"
          MESSAGE="${{ steps.lint.outputs.message }}"
          ERRORS="${{ steps.lint.outputs.errors }}"
          WARNINGS="${{ steps.lint.outputs.warnings }}"
          
          # Prepare the comment
          if [ "$STATUS" = "success" ]; then
            ICON="✅"
            HEADER="## Lint Check Passed"
          elif [ "$STATUS" = "warning" ]; then
            ICON="⚠️"
            HEADER="## Lint Check Warning"
          else
            ICON="❌"
            HEADER="## Lint Check Failed"
          fi
          
          COMMENT="$HEADER\n\n"
          COMMENT+="$ICON $MESSAGE\n\n"
          
          if [ "$ERRORS" != "0" ] || [ "$WARNINGS" != "0" ]; then
            COMMENT+="### Summary:\n"
            COMMENT+="- Errors: $ERRORS\n"
            COMMENT+="- Warnings: $WARNINGS\n"
            COMMENT+="- Total Issues: $((ERRORS + WARNINGS))\n\n"
            
            if [ "$STATUS" = "failure" ]; then
              COMMENT+="❗ The total number of issues exceeds the maximum limit of 200.\n"
              COMMENT+="Please fix the issues before merging.\n"
            fi
          fi
          
          echo -e "$COMMENT" | gh pr comment ${{ github.event.pull_request.number }} --body-file -

      - name: Check final status
        if: steps.lint.outputs.status == 'failure'
        run: |
          echo "::error::Lint check failed. Total issues exceed maximum limit of 200."
          exit 1