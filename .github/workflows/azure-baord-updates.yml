name: Azure Boards PR Integration

on:
  pull_request:
    types: [opened, reopened, edited, closed, synchronize]

env:
  AZURE_DEVOPS_PAT: ${{ secrets.AZURE_DEVOPS_PAT }}
  AZURE_DEVOPS_ORG: ${{ secrets.AZURE_DEVOPS_ORG }}

jobs:
  update-azure-board:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Extract Board ID and Check Duplicates
        id: branch-validation
        uses: actions/github-script@v6
        with:
          script: |
            const currentBranch = context.payload.pull_request.head.ref;
            const defaultBranchPattern = /^(main|develop|develop2|test|test\/.*|develop\/.*|^hotfix$)$/;
            
            // Check if default branch
            if (defaultBranchPattern.test(currentBranch)) {
              core.setOutput('is_default_branch', 'true');
              core.setOutput('board_id', '');
              return;
            }
            
            // Extract board ID
            const boardIdMatch = currentBranch.match(/(?<=#)\d+(?=-)/);
            const boardId = boardIdMatch ? boardIdMatch[0] : '';
            
            if (!boardId) {
              core.setOutput('is_default_branch', 'false');
              core.setOutput('board_id', '');
              return;
            }
            
            // Check for duplicate branches
            try {
              const { data: branches } = await github.rest.repos.listBranches({
                owner: context.repo.owner,
                repo: context.repo.repo,
                per_page: 100
              });
              
              const duplicateBranches = branches.filter(branch => {
                if (branch.name === currentBranch) return false;
                const storyMatch = branch.name.match(/(?<=#)\d+(?=-)/);
                return storyMatch && storyMatch[0] === boardId;
              });
              
              if (duplicateBranches.length > 0) {
                const errorMessage = `âŒ **Error: Duplicate Story Branch**\n\nFound existing branches for story #${boardId}:\n${duplicateBranches.map(b => `- ${b.name}`).join('\n')}\n\nPlease close this PR and use the existing branch(es) or close the other PR(s) first.`;
                
                // Check for existing error comments
                const { data: existingComments } = await github.rest.issues.listComments({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.payload.pull_request.number
                });
                
                const hasErrorComment = existingComments.some(comment => 
                  comment.user.type === 'Bot' && 
                  comment.body.includes('**Error: Duplicate Story Branch**')
                );
                
                // Only post if no existing error comment found
                if (!hasErrorComment) {
                  await github.rest.issues.createComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: context.payload.pull_request.number,
                    body: errorMessage
                  });
                }
                
                core.setFailed('Duplicate branches found');
                core.setOutput('has_duplicates', 'true');
                return;
              }
              
              core.setOutput('is_default_branch', 'false');
              core.setOutput('board_id', boardId);
              core.setOutput('has_duplicates', 'false');
              
            } catch (error) {
              core.setFailed(`Error checking for duplicate branches: ${error.message}`);
            }