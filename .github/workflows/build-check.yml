name: Build Check

on:
  pull_request:
    types: [opened, edited, synchronize]

permissions:
  pull-requests: write
  issues: write

jobs:
  check-build:
    runs-on: ubuntu-latest

    steps:
      - name: Check out the repository
        uses: actions/checkout@v2

      - name: Set up Node.js
        uses: actions/setup-node@v2
        with:
          node-version: "22.13.1"

      - name: Install dependencies
        run: npm install

      - name: Determine build command
        id: determine-build
        run: |
          BRANCH_NAME="${{ github.event.pull_request.head.ref }}"
          if [[ "$BRANCH_NAME" == "develop" || "$BRANCH_NAME" == develop/* ]]; then
            echo "BUILD_COMMAND=npm run build-dev" >> $GITHUB_ENV
            echo "BUILD_ENV=Development" >> $GITHUB_ENV
          elif [[ "$BRANCH_NAME" == "test" || "$BRANCH_NAME" == test/* ]]; then
            echo "BUILD_COMMAND=npm run build-qa" >> $GITHUB_ENV
            echo "BUILD_ENV=QA" >> $GITHUB_ENV
          elif [[ "$BRANCH_NAME" == "main" ]]; then
            echo "BUILD_COMMAND=npm run build-qa" >> $GITHUB_ENV
            echo "BUILD_ENV=QA" >> $GITHUB_ENV
          elif [[ "$BRANCH_NAME" == "hotfix" || "$BRANCH_NAME" == release/* ]]; then
            echo "BUILD_COMMAND=npm run build-hotfix" >> $GITHUB_ENV
            echo "BUILD_ENV=Hotfix" >> $GITHUB_ENV
          elif [[ "$BRANCH_NAME" == "pentest" || "$BRANCH_NAME" == pen/* ]]; then
            echo "BUILD_COMMAND=npm run build-pen" >> $GITHUB_ENV
            echo "BUILD_ENV=Pentest" >> $GITHUB_ENV
          else
            echo "BUILD_COMMAND=npm run build-dev" >> $GITHUB_ENV
            echo "BUILD_ENV=Development" >> $GITHUB_ENV
          fi

      - name: Run build
        id: build
        continue-on-error: true
        run: |
          echo "Running build command: $BUILD_COMMAND"
          if $BUILD_COMMAND > build-output.txt 2>&1; then
            echo "BUILD_STATUS=success" >> $GITHUB_ENV
          else
            echo "BUILD_STATUS=failed" >> $GITHUB_ENV
            # Capture the last few lines of the error output
            ERROR_MSG=$(tail -n 10 build-output.txt)
            echo "ERROR_MSG<<EOF" >> $GITHUB_ENV
            echo "$ERROR_MSG" >> $GITHUB_ENV
            echo "EOF" >> $GITHUB_ENV
          fi

      - name: Comment on PR if build fails
        if: env.BUILD_STATUS == 'failed'
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const errorMsg = process.env.ERROR_MSG || 'Error details not available';
            const buildEnv = process.env.BUILD_ENV || 'Unknown';
            
            const message = `## ‚ùå Build Failed
            
            The build process for the **${buildEnv}** environment has failed.
            
            ### Build Error Details:
            \`\`\`
            ${errorMsg}
            \`\`\`
            
            ### Next Steps:
            1. Review the error message above
            2. Check the complete build logs in the pipeline for more details
            3. Try to reproduce and fix the build error locally
            4. Push your changes to trigger a new build
            
            If you need help interpreting these errors, please reach out to the team.`;
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: message
            });
            
            throw new Error('Build failed');