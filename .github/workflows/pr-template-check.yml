name: PR Template Check

on:
  pull_request:
    types: [opened, edited, synchronize]

jobs:
  check-pr-template:
    runs-on: ubuntu-latest

    steps:
      - name: Check out repository
        uses: actions/checkout@v2

      - name: Validate PR description
        id: validate
        run: |
          PR_BODY=$(jq -r .pull_request.body "$GITHUB_EVENT_PATH")
          
          # Initialize validation flags
          VALIDATION_FAILED=false
          MISSING_FIELDS=()
          
          # Check for required sections
          REQUIRED_SECTIONS=(
            "Type of Change"
            "Current Behavior"
            "New Behavior"
            "Breaking Changes"
            "UI Platform Standards Compliance"
            "Quality Assurance"
          )
          
          for SECTION in "${REQUIRED_SECTIONS[@]}"; do
            if ! echo "$PR_BODY" | grep -q "$SECTION"; then
              MISSING_FIELDS+=("$SECTION")
              VALIDATION_FAILED=true
            fi
          done
          
          # Check if at least one checkbox is checked in required sections
          TYPE_CHECKED=$(echo "$PR_BODY" | grep -c '\- \[x\]' || true)
          if [ "$TYPE_CHECKED" -eq 0 ]; then
            MISSING_FIELDS+=("At least one change type must be selected")
            VALIDATION_FAILED=true
          fi
          
          # Check Breaking Changes selection
          if ! echo "$PR_BODY" | grep -q '\- \[x\] \(Yes\|No\) *$'; then
            MISSING_FIELDS+=("Breaking Changes selection required")
            VALIDATION_FAILED=true
          fi
          
          # Check UI Platform Standards compliance
          if ! echo "$PR_BODY" | grep -q '\- \[x\] \(Yes\|No\) *$'; then
            MISSING_FIELDS+=("UI Platform Standards compliance selection required")
            VALIDATION_FAILED=true
          fi
          
          # Check Quality Assurance section
          QA_CHECKED=$(echo "$PR_BODY" | grep -c '\- \[x\]' || true)
          if [ "$QA_CHECKED" -eq 0 ]; then
            MISSING_FIELDS+=("Quality Assurance checkboxes must be completed")
            VALIDATION_FAILED=true
          fi
          
          # Output results
          if [ "$VALIDATION_FAILED" = true ]; then
            echo "::error::PR template validation failed. Missing or incomplete fields:"
            printf '%s\n' "${MISSING_FIELDS[@]}"
            exit 1
          fi
          
          echo "PR template validation passed"

      - name: Comment on PR
        if: failure()
        uses: actions/github-script@v6
        with:
          script: |
            const missingFields = process.env.MISSING_FIELDS.split(',');
            
            const errorMessage = `## âŒ PR Template Validation Failed
            
            This pull request does not follow the required template. Please update the PR description to include the following missing or incomplete sections:
            
            ${missingFields.map(field => `- ${field}`).join('\n')}
            
            Please edit your PR description to include all required information. This helps reviewers better understand your changes.
            
            ### Required Actions:
            1. Click the "Edit" button on your PR
            2. Fill in all missing sections
            3. Ensure all appropriate checkboxes are checked
            4. Save your changes
            
            The PR validation will automatically run again after you make your changes.`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: errorMessage
            });