name: PR Template Check

on:
  pull_request:
    types: [opened, edited]

permissions:
  pull-requests: write
  contents: read
  issues: write

jobs:
  check-pr-template:
    runs-on: ubuntu-latest

    steps:
      - name: Check out repository
        uses: actions/checkout@v2

      - name: Validate PR description
        id: validate
        run: |
          PR_BODY=$(jq -r .pull_request.body "$GITHUB_EVENT_PATH")

          # Initialize validation flags
          MISSING_FIELDS=()

          # Check for required sections
          REQUIRED_SECTIONS=(
              "Description"
              "Type of Change"
              "Breaking Changes"
              "UI Platform Standards Compliance"
          )

          for SECTION in "${REQUIRED_SECTIONS[@]}"; do
              if ! echo "$PR_BODY" | grep -q "$SECTION"; then
                  MISSING_FIELDS+=("$SECTION")
              fi
          done

          # Check if Description section has content
          DESCRIPTION_SECTION=$(echo "$PR_BODY" | sed -n '/## Description/,/##/p' || echo "$PR_BODY")
          # Remove section header and comments
          DESCRIPTION_CONTENT=$(echo "$DESCRIPTION_SECTION" | grep -v "^##" | grep -v "^<!--" | grep -v "^-->" | tr -d '[:space:]')
          if [ -z "$DESCRIPTION_CONTENT" ]; then
              MISSING_FIELDS+=("Description content is required")
          fi

          # Check if at least one checkbox is checked in Type of Change section
          TYPE_SECTION=$(echo "$PR_BODY" | sed -n '/## Type of Change/,/##/p' || echo "$PR_BODY")
          TYPE_CHECKED=$(echo "$TYPE_SECTION" | grep -c '\- \[x\]' || true)
          if [ "$TYPE_CHECKED" -eq 0 ]; then
              MISSING_FIELDS+=("At least one change type must be selected")
          fi

          # Check Breaking Changes selection
          BREAKING_SECTION=$(echo "$PR_BODY" | sed -n '/## Breaking Changes/,/##/p' || echo "$PR_BODY")
          BREAKING_CHECKED=$(echo "$BREAKING_SECTION" | grep -c '\- \[x\]' || true)
          if [ "$BREAKING_CHECKED" -eq 0 ]; then
              MISSING_FIELDS+=("Breaking Changes selection required")
          fi

          # Check UI Platform Standards compliance
          UI_SECTION=$(echo "$PR_BODY" | sed -n '/## UI Platform Standards Compliance/,/##/p' || echo "$PR_BODY")
          UI_CHECKED=$(echo "$UI_SECTION" | grep -c '\- \[x\]' || true)
          if [ "$UI_CHECKED" -eq 0 ]; then
              MISSING_FIELDS+=("UI Platform Standards compliance selection required")
          fi

          # Set output for next step
          echo "MISSING_FIELDS<<EOF" >> $GITHUB_ENV
          printf '%s\n' "${MISSING_FIELDS[@]}" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

          # Exit with error if there are missing fields
          if [ ${#MISSING_FIELDS[@]} -ne 0 ]; then
              echo "::error::PR template validation failed. Missing or incomplete fields:"
              printf '%s\n' "${MISSING_FIELDS[@]}"
              exit 1
          fi

          echo "PR template validation passed"

      - name: Manage PR Comments
        if: always()
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // First, get all existing comments
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });
            
            // Delete existing template check comments
            for (const comment of comments) {
              if (comment.body.includes('PR Template Validation Failed') ||
                  comment.user.login === 'github-actions[bot]') {
                try {
                  await github.rest.issues.deleteComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    comment_id: comment.id
                  });
                } catch (error) {
                  console.error(`Error deleting comment ${comment.id}:`, error);
                }
              }
            }

            // Only create new comment if validation failed
            if (process.env.MISSING_FIELDS) {
              const missingFields = process.env.MISSING_FIELDS.split('\n').filter(Boolean);
              
              let message = ""
              message += "**âŒ PR Template Validation Failed**\n\n"
            message += "This pull request does not follow the required template. "
            message += "Please update the PR description to include the following missing or incomplete sections:\n\n"
            
            missingFields.forEach(field => {
                message += `- ${field}\n`
            });
            
            message += "\n### Required Template Sections:\n"
            message += "1. Description (must include detailed information)\n"
            message += "2. Type of Change (select at least one option)\n"
            message += "3. Breaking Changes (indicate yes/no)\n"
            message += "4. UI Platform Standards Compliance (confirm compliance)\n"

              await github.rest.issues.createComment({
                  issue_number: context.issue.number,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: message
              });
            }