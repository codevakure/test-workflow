name: Workflow Dispatcher

on:
  pull_request:
    types: [opened, reopened, edited, closed, synchronize]
  push:
    branches:
      - main
      - develop
  workflow_dispatch:

env:
  AZURE_DEVOPS_PAT: ${{ secrets.AZURE_DEVOPS_PAT }}
  AZURE_DEVOPS_ORG: ${{ secrets.AZURE_DEVOPS_ORG }}
  TEMPLATE_REPOSITORY: ${{ vars.TEMPLATE_REPOSITORY || 'codevakure/github-workflows' }}
  TEMPLATE_BRANCH: ${{ vars.TEMPLATE_BRANCH || 'main' }}

jobs:
  sync-templates:
    if: github.event_name == 'workflow_dispatch' || github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
      - name: Sync Repository Templates
        uses: actions/github-script@v6
        with:
          script: |
            const config = JSON.parse(process.env.WORKFLOW_CONFIGS);
            const repoConfig = config.repository?.templates;
            if (!repoConfig) return;
            
            const [owner, repo] = process.env.TEMPLATE_REPOSITORY.split('/');
            
            // Sync CODEOWNERS
            if (repoConfig.codeowners?.enabled) {
              const template = await github.rest.repos.getContent({
                owner,
                repo,
                path: `.github/CODEOWNERS_TEMPLATES/${repoConfig.codeowners.template}`
              });
              // Rest of the logic...
            }
            
            // Sync PR Template
            if (repoConfig.pull_request?.enabled) {
              const template = await github.rest.repos.getContent({
                owner,
                repo,
                path: `.github/PULL_REQUEST_TEMPLATE/${repoConfig.pull_request.template}.md`
              });
              // Rest of the logic...
            }

  dispatch-workflows:
    runs-on: ubuntu-latest
    steps:
      - name: Process Workflows
        uses: actions/github-script@v6
        with:
          script: |
            const config = JSON.parse(process.env.WORKFLOW_CONFIGS);
            const templateRepo = process.env.TEMPLATE_REPOSITORY;
            const templateBranch = process.env.TEMPLATE_BRANCH;
            
            // Rest of workflow dispatch logic...
            
            jobs[workflowName] = {
              uses: `${templateRepo}/.github/workflows/${workflowName}.yml@${templateBranch}`,
              with: {
                config: JSON.stringify(workflowConfig.config || {})
              },
              secrets: {
                AZURE_DEVOPS_PAT: process.env.AZURE_DEVOPS_PAT,
                AZURE_DEVOPS_ORG: process.env.AZURE_DEVOPS_ORG
              }
            };