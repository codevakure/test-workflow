name: Workflow Dispatcher

on:
  pull_request:
    types: [opened, reopened, edited, closed, synchronize]
  push:
    branches:
      - main
      - develop
  workflow_dispatch:

env:
  AZURE_DEVOPS_PAT: ${{ secrets.AZURE_DEVOPS_PAT }}
  AZURE_DEVOPS_ORG: ${{ secrets.AZURE_DEVOPS_ORG }}
  TEMPLATE_REPOSITORY: ${{ vars.TEMPLATE_REPOSITORY || 'codevakure/github-workflows' }}
  TEMPLATE_BRANCH: ${{ vars.TEMPLATE_BRANCH || 'main' }}
  WORKFLOW_CONFIGS: ${{ vars.WORKFLOW_CONFIGS }}

jobs:
  sync-templates:
    if: github.event_name == 'workflow_dispatch' || github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
      - name: Sync Repository Templates
        uses: actions/github-script@v6
        with:
          script: |
            const config = JSON.parse(process.env.WORKFLOW_CONFIGS);
            const repoConfig = config.repository?.templates;
            if (!repoConfig) return;
            
            const [owner, repo] = process.env.TEMPLATE_REPOSITORY.split('/');
            
            // Sync CODEOWNERS
            if (repoConfig.codeowners?.enabled) {
              const template = await github.rest.repos.getContent({
                owner,
                repo,
                path: `.github/CODEOWNERS_TEMPLATES/${repoConfig.codeowners.template}`
              });
              
              let content = Buffer.from(template.data.content, 'base64').toString();
              const ownerList = repoConfig.codeowners.config.REPO_OWNERS.join(' ');
              content = content.replace('@REPO_OWNERS', ownerList);
              
              await github.rest.repos.createOrUpdateFileContents({
                owner: context.repo.owner,
                repo: context.repo.repo,
                path: '.github/CODEOWNERS',
                message: 'Update CODEOWNERS file',
                content: Buffer.from(content).toString('base64'),
                committer: { name: 'GitHub Actions', email: 'actions@github.com' }
              });
            }
            
            // Sync PR Template
            if (repoConfig.pull_request?.enabled) {
              const template = await github.rest.repos.getContent({
                owner,
                repo,
                path: `.github/PULL_REQUEST_TEMPLATE/${repoConfig.pull_request.template}.md`
              });
              
              await github.rest.repos.createOrUpdateFileContents({
                owner: context.repo.owner,
                repo: context.repo.repo,
                path: '.github/pull_request_template.md',
                message: 'Update PR template',
                content: template.data.content,
                committer: { name: 'GitHub Actions', email: 'actions@github.com' }
              });
            }

  dispatch-workflows:
    runs-on: ubuntu-latest
    permissions:
      actions: write # Add this to ensure proper permissions
    steps:
      - name: Process Workflows
        uses: actions/github-script@v6
        with:
          script: |
            const config = JSON.parse(process.env.WORKFLOW_CONFIGS);
            const templateRepo = process.env.TEMPLATE_REPOSITORY;
            const templateBranch = process.env.TEMPLATE_BRANCH;
            
            const eventType = context.eventName;
            const eventAction = context.payload.action;
            
            if (!config.workflows) {
              console.log('No workflows configured, skipping...');
              return;
            }

            for (const [workflowName, workflowConfig] of Object.entries(config.workflows)) {
              // Fix the filename to match exactly what's in the repo
              const actualWorkflowName = workflowName.replace('boards', 'baords');
              
              if (!workflowConfig || workflowConfig.enabled !== true) {
                console.log(`Workflow ${actualWorkflowName} not enabled, skipping...`);
                continue;
              }
              
              const shouldRun = workflowConfig.triggers?.[eventType];
              if (!shouldRun) continue;
              
              if (eventType === 'pull_request' && 
                  !workflowConfig.triggers.pull_request.types.includes(eventAction)) {
                continue;
              }
              
              console.log(`Triggering workflow ${actualWorkflowName} from ${templateRepo}`);
              
              try {
                await github.rest.actions.createWorkflowDispatch({
                  owner: templateRepo.split('/')[0],
                  repo: templateRepo.split('/')[1],
                  workflow_id: actualWorkflowName,
                  ref: templateBranch,
                  inputs: {
                    config: JSON.stringify(workflowConfig.config || {})
                  }
                });
              } catch (error) {
                console.log(`Error triggering workflow: ${error.message}`);
                throw error;
              }
            }